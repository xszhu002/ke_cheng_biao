# 课程表管理系统 - 项目结构文档

## 项目概述

这是一个基于Web的课程表管理系统，支持多教师课程表管理、拖拽换课、原始课程表保存与复位、特需托管、随手记笔记等功能。系统采用前后端分离架构，使用原生技术栈实现，尽可能减少外部依赖。

### 核心功能

- **多教师管理**：支持多个教师各自的课程表
- **拖拽换课**：直观的拖拽界面进行临时换课
- **原始课程表**：学期初保存基准课程表，支持随时复位
- **特需托管**：支持非周期性的特殊课程安排
- **日历管理**：基于学期时间的周次计算
- **实时保存**：拖拽操作自动保存，无需手动确认
- **随手记笔记**：支持每周笔记记录，支持Markdown格式
- **管理员后台**：完整的教师管理和系统配置界面
- **消息提示系统**：友好的Toast提示反馈

## 技术栈

### 后端技术

- **运行时**：Node.js
- **Web框架**：Express.js
- **数据库**：SQLite3 (轻量级文件数据库)
- **中间件**：CORS、Body-Parser、Express-Session
- **加密**：bcryptjs (密码加密)
- **工具库**：uuid (唯一标识符生成)

### 前端技术

- **核心**：原生 HTML5、CSS3、JavaScript (ES6+)
- **UI组件**：无外部UI库，纯手工实现
- **布局**：CSS Grid、Flexbox
- **交互**：HTML5 Drag & Drop API、Fetch API
- **样式特性**：CSS变量、动画、响应式设计

### 开发工具

- **包管理**：npm
- **开发服务器**：nodemon (自动重启)
- **数据库管理**：SQLite命令行工具

## 项目目录结构

```
kechenbiao/
├── package.json                 # 项目配置文件
├── package-lock.json           # 依赖锁定文件
├── server.js                   # 主服务器文件 (1789行)
├── 设计方案.md                 # 原始设计文档
├── 项目结构.md                 # 本文档
├── 重要提示词.md               # 开发提示词
├── CLAUDE.md                   # AI助手工作记录
├── README.md                   # 项目说明文档
│
├── database/                   # 数据库目录
│   └── schedule.db            # SQLite数据库文件
│
├── scripts/                   # 脚本目录
│   ├── init-db.js            # 数据库初始化脚本 (257行)
│   ├── migrate-db.js         # 数据库迁移脚本
│   └── cleanup-db.js         # 数据库清理脚本
│
├── public/                    # 前端静态文件
│   ├── index.html            # 主页面 (551行)
│   ├── admin.html            # 管理员后台 (2931行)
│   ├── admin-test.html       # 管理员测试页面 (124行)
│   ├── favicon.ico           # 网站图标
│   │
│   ├── css/                  # 样式文件
│   │   ├── main.css         # 主样式 (1195行)
│   │   ├── schedule.css     # 课程表样式 (773行)
│   │   ├── calendar.css     # 日历样式 (463行)
│   │   └── components.css   # 组件样式 (618行)
│   │
│   ├── js/                   # JavaScript文件
│   │   ├── app.js           # 应用入口 (363行)
│   │   ├── api.js           # API客户端 (654行)
│   │   ├── schedule.js      # 课程表管理 (1697行)
│   │   ├── dragdrop.js      # 拖拽功能 (532行)
│   │   ├── calendar.js      # 日历管理 (448行)
│   │   ├── notes.js         # 随手记管理 (289行)
│   │   ├── toast.js         # 消息提示系统 (138行)
│   │   └── utils.js         # 工具函数 (661行)
│   │
│   └── assets/              # 静态资源目录
│
├── image/                     # 项目图片资源
│   └── 重要提示词/           # 提示词相关图片
│
├── node_modules/            # npm依赖包
├── .git/                   # Git版本控制
├── .claude/                # AI助手工作目录
└── .specstory/            # 规格故事目录
```

## 数据库设计

### 数据库技术选择

- **SQLite3**：文件型数据库，无需单独服务器
- **事务支持**：确保复位等复杂操作的数据一致性
- **轻量级**：适合单机部署和小规模使用

### 表结构设计

#### 1. teachers (教师表)

```sql
CREATE TABLE teachers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,        -- 教师姓名
    email VARCHAR(255),                -- 邮箱地址
    phone VARCHAR(20),                 -- 联系电话
    department VARCHAR(100),           -- 所属部门
    is_active BOOLEAN DEFAULT TRUE,    -- 是否启用
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. semester_config (学期配置表)

```sql
CREATE TABLE semester_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    semester_name VARCHAR(100) NOT NULL,  -- 学期名称
    start_date DATE NOT NULL,             -- 学期开始日期
    end_date DATE NOT NULL,               -- 学期结束日期
    is_current BOOLEAN DEFAULT FALSE,     -- 是否为当前学期
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 3. schedules (课程表表)

```sql
CREATE TABLE schedules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    teacher_id INTEGER NOT NULL,         -- 关联教师ID
    name VARCHAR(100) NOT NULL,          -- 课程表名称
    semester_id INTEGER NOT NULL,        -- 关联学期ID
    is_active BOOLEAN DEFAULT TRUE,      -- 是否启用
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (teacher_id) REFERENCES teachers(id),
    FOREIGN KEY (semester_id) REFERENCES semester_config(id)
);
```

#### 4. course_arrangements (课程安排表) - 核心表

```sql
CREATE TABLE course_arrangements (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    schedule_id INTEGER NOT NULL,        -- 关联课程表ID
    weekday INTEGER,                     -- 周几 (1-5)，特需托管为NULL
    time_slot INTEGER NOT NULL,         -- 时间段 (1-9)
    course_name VARCHAR(100) NOT NULL,   -- 课程名称
    classroom VARCHAR(50),               -- 教室
    course_type VARCHAR(20) DEFAULT 'regular',  -- 课程类型
    specific_date DATE,                  -- 特需托管的具体日期
    notes TEXT,                          -- 备注
    is_original BOOLEAN DEFAULT FALSE,   -- 是否为原始课程表
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (schedule_id) REFERENCES schedules(id)
);
```

#### 5. operation_history (操作历史表)

```sql
CREATE TABLE operation_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    schedule_id INTEGER NOT NULL,       -- 关联课程表ID
    operation_type VARCHAR(20) NOT NULL, -- 操作类型 ('move', 'add', 'delete', 'update')
    old_data TEXT,                      -- JSON格式的旧数据
    new_data TEXT,                      -- JSON格式的新数据
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (schedule_id) REFERENCES schedules(id)
);
```

### 核心数据逻辑

#### 原始课程表与临时课程表

- **原始课程表** (`is_original = TRUE`)：学期初设置的基准课程表，用于复位参考
- **临时课程表** (`is_original = FALSE`)：日常操作的课程表，用户实际看到的内容

#### 复位机制

1. 查找该课程表的所有原始课程 (`is_original = TRUE`)
2. 删除该课程表的所有课程 (包括原始和临时)
3. 重新插入原始课程 (保持原始标记)
4. 复制原始课程为新的临时课程 (设为非原始)

## API设计

### RESTful API架构

- **统一前缀**：`/api/`
- **HTTP动词**：GET (查询)、POST (创建)、PUT (更新)、DELETE (删除)
- **状态码**：200 (成功)、400 (参数错误)、404 (未找到)、500 (服务器错误)
- **数据格式**：JSON

### API端点列表

#### 教师管理

```
GET    /api/teachers              # 获取所有教师
POST   /api/teachers              # 创建教师
PUT    /api/teachers/:id          # 更新教师信息
DELETE /api/teachers/:id          # 删除教师
```

#### 课程表管理

```
GET    /api/schedules/teacher/:teacherId    # 获取教师的课程表
GET    /api/schedules/:scheduleId/week/:week # 获取指定周的课程数据
POST   /api/schedules/:id/save-original     # 保存为原始课程表
POST   /api/schedules/:id/reset             # 复位到原始课程表
```

#### 课程管理

```
POST   /api/courses                    # 创建课程
PUT    /api/courses/:id/move          # 移动课程位置
DELETE /api/courses/:id               # 删除课程
```

#### 特需托管管理

```
POST   /api/special-care              # 创建特需托管
GET    /api/special-care/:scheduleId/:date # 获取指定日期的特需托管
PUT    /api/special-care/:id          # 更新特需托管
DELETE /api/special-care/:id          # 删除特需托管
```

#### 日历和学期管理

```
GET    /api/calendar/semester/current # 获取当前学期信息
```

### API数据格式示例

#### 课程数据格式

```json
{
  "id": 1,
  "schedule_id": 1,
  "weekday": 1,
  "time_slot": 3,
  "course_name": "信息科技",
  "classroom": "505",
  "course_type": "regular",
  "specific_date": null,
  "notes": "",
  "is_original": false,
  "created_at": "2024-01-01T00:00:00.000Z",
  "updated_at": "2024-01-01T00:00:00.000Z"
}
```

## 前端架构

### 模块化设计

前端采用ES6模块化和面向对象设计，主要分为以下模块：

#### 1. 应用入口 (app.js)

- **ScheduleApp类**：应用主控制器
- **初始化管理**：协调各个管理器的初始化
- **全局事件处理**：窗口resize、键盘快捷键等
- **状态管理**：应用级状态维护

#### 2. API客户端 (api.js)

- **ApiClient类**：HTTP请求封装
- **专用API对象**：TeacherAPI、ScheduleAPI、CourseAPI等
- **错误处理**：统一的错误处理机制
- **加载指示器**：请求状态的UI反馈

#### 3. 课程表管理 (schedule.js)

- **ScheduleManager类**：课程表核心逻辑
- **数据渲染**：将API数据渲染为DOM
- **教师切换**：多教师间的切换逻辑
- **周次导航**：学期周次的前进后退

#### 4. 拖拽功能 (dragdrop.js)

- **DragDropManager类**：拖拽交互管理
- **HTML5 Drag API**：原生拖拽事件处理
- **位置计算**：拖拽目标位置的精确计算
- **实时反馈**：拖拽过程的视觉反馈

#### 5. 日历管理 (calendar.js)

- **CalendarManager类**：日历显示和交互
- **月份渲染**：动态生成月份视图
- **日期选择**：特需托管日期的选择
- **标记显示**：已安排特需托管的日期标记

#### 6. 随手记管理 (notes.js)

- **WeeklyNotesManager类**：周记笔记管理
- **Markdown渲染**：支持Markdown格式笔记
- **实时编辑**：支持预览/编辑模式切换
- **自动保存**：笔记内容自动保存

#### 7. 消息提示系统 (toast.js)

- **ToastManager类**：消息提示管理
- **多种类型**：success、error、warning、info
- **自动关闭**：可配置显示时长
- **动画效果**：优雅的进入和退出动画

#### 8. 工具函数 (utils.js)

- **DateUtils**：日期时间处理
- **DOMUtils**：DOM操作封装
- **ValidationUtils**：数据验证
- **NotificationUtils**：消息提示
- **StringUtils**：字符串处理

### CSS架构

#### 1. 主样式 (main.css)

- **CSS变量**：统一的颜色、尺寸定义
- **基础布局**：页面整体布局和容器
- **响应式设计**：不同屏幕尺寸的适配

#### 2. 课程表样式 (schedule.css)

- **表格布局**：CSS Grid实现的课程表网格
- **课程块样式**：不同学科的颜色区分
- **拖拽状态**：拖拽过程的视觉效果

#### 3. 日历样式 (calendar.css)

- **日历网格**：月历的网格布局
- **日期状态**：当前日期、选中日期、标记日期的样式
- **交互效果**：hover、active状态的反馈

#### 4. 组件样式 (components.css)

- **按钮组件**：统一的按钮样式体系
- **表单组件**：输入框、选择器等表单元素
- **模态框**：弹窗对话框的样式
- **通知组件**：成功、警告、错误消息的样式

### 时间段定义

系统定义了9个时间段：

1. **上午1** (8:30-9:10)
2. **上午2** (9:50-10:30)
3. **上午3** (10:45-11:30)
4. **午间管理** (午休时间)
5. **下午1** (13:30-14:10)
6. **下午2** (14:20-15:05)
7. **下午3** (15:15-15:55)
8. **晚托** (放学后托管)
9. **特需托管** (特殊安排) - 专门用于非周期性课程

## 核心功能实现

### 1. 拖拽换课机制

- **事件监听**：在课程块上绑定dragstart事件
- **数据传递**：通过dataTransfer传递课程信息
- **目标检测**：检测有效的drop目标
- **位置更新**：调用API更新课程位置
- **实时刷新**：更新成功后重新渲染课程表

### 2. 原始课程表保存机制

- **保存操作**：将当前所有课程标记为原始 (`is_original = TRUE`)
- **确认机制**：弹窗确认防止误操作
- **事务处理**：使用数据库事务确保操作原子性

### 3. 复位功能实现

- **检查原始数据**：确认是否存在原始课程表
- **清理数据**：删除所有现有课程 (原始+临时)
- **恢复数据**：重新插入原始课程和对应的临时课程
- **界面刷新**：重新加载课程表显示

### 4. 特需托管机制

- **非周期性**：不按周重复，指定具体日期
- **专用时间段**：使用第9时间段
- **日历标记**：在日历上显示已安排的特需托管
- **周次显示**：在对应周的课程表中显示

### 5. 多教师支持

- **教师切换**：下拉选择器切换不同教师
- **独立课程表**：每个教师有独立的课程表数据
- **互相可见**：教师间可以查看彼此的课程表

## 部署和运行

### 环境要求

- **Node.js**：v14.0+ (推荐v18+)
- **npm**：v6.0+
- **浏览器**：支持ES6+和HTML5 Drag & Drop API

### 安装和启动

```bash
# 安装依赖
npm install

# 初始化数据库
npm run init-db

# 启动开发服务器
npm run dev

# 生产环境启动
npm start
```

### 访问地址

- **开发环境**：http://localhost:3000
- **数据库文件**：./database/schedule.db

## 项目特色

### 1. 无外部前端依赖

- 不使用React、Vue等框架
- 不依赖jQuery、Bootstrap等库
- 纯原生技术栈实现复杂交互

### 2. 轻量级部署

- SQLite文件数据库，无需数据库服务器
- 单一Node.js进程，资源占用少
- 静态文件服务，可部署到简单Web服务器

### 3. 直观的用户体验

- 拖拽操作符合用户直觉
- 实时保存无需手动确认
- 清晰的视觉反馈和状态提示

### 4. 灵活的课程管理

- 支持常规课程和特殊安排
- 原始课程表和临时变更的分离
- 多教师独立管理但互相可见

## 代码统计

### 文件规模

- **总代码行数**：约9,000+行
- **JavaScript**：4,500+行 (8个文件)
- **CSS**：3,000+行 (4个文件)
- **HTML**：3,600+行 (3个文件)
- **Node.js**：1,800+行 (主服务器 + 脚本文件)

### 技术占比

- **前端代码**：75% (HTML/CSS/JS)
- **后端代码**：20% (Node.js/Express)
- **数据库**：5% (SQLite/SQL)

### 主要功能模块

- **课程表管理**：拖拽操作、多教师支持、原始课程表保存与复位
- **特需托管**：非周期性特殊课程安排
- **随手记笔记**：支持Markdown格式的周记功能
- **管理员后台**：教师管理、系统配置、数据维护
- **消息提示**：友好的用户反馈系统

这个项目展示了如何用最小的技术栈实现功能完整的Web应用，具有良好的用户体验和完善的管理功能，适合作为学习现代Web开发的实例，也适合实际的中小规模课程表管理需求。
