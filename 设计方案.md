# 网页版课程表系统详细设计方案

## 项目概述

### 项目目标

开发一个轻量级的网页版课程表管理系统，支持多教师课程表管理、拖拽换课、特需托管安排和日历管理功能。

### 核心特性

- 纯Web技术实现，无需复杂依赖
- 支持拖拽操作调整课程安排
- 多教师课程表管理
- 特需托管日历标记与管理
- 数据持久化与恢复功能
- 东八区时间支持

## 技术架构

### 前端技术栈

- **HTML5**: 页面结构和语义化标签
- **CSS3**: 样式设计、Grid布局、Flexbox、动画效果
- **原生JavaScript (ES6+)**:
  - DOM操作
  - 事件处理
  - 拖拽API (HTML5 Drag and Drop)
  - Fetch API进行HTTP请求
  - 日期处理和时区转换

### 后端技术栈

- **Node.js**: JavaScript运行环境
- **Express.js**: Web框架
  - 静态文件服务
  - API路由处理
  - JSON解析中间件
  - CORS支持
- **SQLite3**:
  - 轻量级数据库
  - 文件型存储
  - 事务支持

### 开发工具

- **VS Code**: 代码编辑器
- **SQLite Browser**: 数据库可视化工具
- **Postman**: API测试工具

## 数据库设计

### 1. 教师表 (teachers)

```sql
CREATE TABLE teachers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100),
    phone VARCHAR(20),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 2. 学期配置表 (semester_config)

```sql
CREATE TABLE semester_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    semester_name VARCHAR(50) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    is_current BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3. 课程表表 (schedules)

```sql
CREATE TABLE schedules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    teacher_id INTEGER NOT NULL,
    name VARCHAR(100) NOT NULL,
    semester_id INTEGER NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (teacher_id) REFERENCES teachers(id),
    FOREIGN KEY (semester_id) REFERENCES semester_config(id)
);
```

### 4. 课程安排表 (course_arrangements)

```sql
CREATE TABLE course_arrangements (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    schedule_id INTEGER NOT NULL,
    weekday INTEGER, -- 1-5 (周一到周五)，特需托管为NULL
    time_slot INTEGER NOT NULL, -- 1-9时间段
    course_name VARCHAR(100) NOT NULL,
    classroom VARCHAR(50),
    course_type VARCHAR(20) DEFAULT 'regular', -- 'regular' 或 'special_care'
    specific_date DATE, -- 仅特需托管使用
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (schedule_id) REFERENCES schedules(id)
);
```

### 5. 操作历史表 (operation_history)

```sql
CREATE TABLE operation_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    schedule_id INTEGER NOT NULL,
    operation_type VARCHAR(20) NOT NULL, -- 'move', 'add', 'delete', 'update'
    old_data TEXT, -- JSON格式的旧数据
    new_data TEXT, -- JSON格式的新数据
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (schedule_id) REFERENCES schedules(id)
);
```

## 前端架构设计

### 文件结构

```
/public/
├── index.html              # 主页面
├── css/
│   ├── main.css           # 主样式文件
│   ├── schedule.css       # 课程表样式
│   ├── calendar.css       # 日历样式
│   └── components.css     # 组件样式
├── js/
│   ├── app.js            # 应用入口
│   ├── schedule.js       # 课程表模块
│   ├── calendar.js       # 日历模块
│   ├── dragdrop.js       # 拖拽功能
│   ├── api.js            # API调用封装
│   └── utils.js          # 工具函数
└── assets/
    ├── icons/            # 图标文件
    └── images/           # 图片资源
```

### 核心模块设计

#### 1. 应用主控制器 (app.js)

```javascript
class ScheduleApp {
    constructor() {
        this.currentTeacher = null;
        this.currentWeek = 1;
        this.currentSemester = null;
        this.scheduleManager = new ScheduleManager();
        this.calendarManager = new CalendarManager();
        this.dragDropManager = new DragDropManager();
    }
  
    async init() {
        // 初始化应用
        // 加载教师列表
        // 设置默认学期
        // 绑定事件监听器
    }
}
```

#### 2. 课程表管理器 (schedule.js)

```javascript
class ScheduleManager {
    constructor() {
        this.timeSlots = [
            { id: 1, name: '上午1', time: '8:30-9:10' },
            { id: 2, name: '上午2', time: '9:50-10:30' },
            { id: 3, name: '上午3', time: '10:45-11:30' },
            { id: 4, name: '午间管理', time: '午休时间' },
            { id: 5, name: '下午1', time: '13:30-14:10' },
            { id: 6, name: '下午2', time: '14:20-15:05' },
            { id: 7, name: '下午3', time: '15:15-15:55' },
            { id: 8, name: '晚托', time: '放学后托管' },
            { id: 9, name: '特需托管', time: '特殊安排' }
        ];
    }
  
    async loadSchedule(teacherId, week) {
        // 加载指定教师和周次的课程表
    }
  
    async updateCourse(courseId, newPosition) {
        // 更新课程位置
    }
  
    renderSchedule(scheduleData) {
        // 渲染课程表界面
    }
}
```

#### 3. 日历管理器 (calendar.js)

```javascript
class CalendarManager {
    constructor() {
        this.currentDate = new Date();
        this.semesterStart = null;
    }
  
    calculateWeekNumber(date) {
        // 计算指定日期是第几周
    }
  
    getWeekDates(weekNumber) {
        // 获取指定周的日期范围
    }
  
    renderCalendar(year, month) {
        // 渲染月历视图
    }
  
    markSpecialCareDates(dates) {
        // 标记特需托管日期
    }
}
```

#### 4. 拖拽管理器 (dragdrop.js)

```javascript
class DragDropManager {
    constructor() {
        this.draggedElement = null;
        this.draggedData = null;
    }
  
    initDragAndDrop() {
        // 初始化拖拽功能
    }
  
    handleDragStart(event) {
        // 拖拽开始处理
    }
  
    handleDragOver(event) {
        // 拖拽悬停处理
    }
  
    handleDrop(event) {
        // 放置处理
    }
  
    validateDrop(source, target) {
        // 验证拖拽操作是否有效
    }
}
```

## 后端API设计

### 路由结构

```
/api/
├── teachers/              # 教师管理
├── schedules/             # 课程表管理
├── courses/               # 课程管理
├── calendar/              # 日历相关
└── special-care/          # 特需托管
```

### API接口定义

#### 1. 教师管理

- `GET /api/teachers` - 获取所有教师
- `POST /api/teachers` - 创建新教师
- `PUT /api/teachers/:id` - 更新教师信息
- `DELETE /api/teachers/:id` - 删除教师

#### 2. 课程表管理

- `GET /api/schedules/teacher/:teacherId` - 获取教师课程表
- `GET /api/schedules/:id/week/:week` - 获取指定周的课程表
- `POST /api/schedules` - 创建新课程表
- `PUT /api/schedules/:id` - 更新课程表

#### 3. 课程管理

- `POST /api/courses` - 添加课程
- `PUT /api/courses/:id/move` - 移动课程位置
- `DELETE /api/courses/:id` - 删除课程
- `POST /api/courses/batch-update` - 批量更新课程

#### 4. 特需托管

- `GET /api/special-care/schedule/:scheduleId` - 获取特需托管列表
- `POST /api/special-care` - 添加特需托管
- `PUT /api/special-care/:id` - 更新特需托管
- `DELETE /api/special-care/:id` - 删除特需托管

#### 5. 日历管理

- `GET /api/calendar/semester/:id` - 获取学期配置
- `POST /api/calendar/semester` - 创建学期
- `GET /api/calendar/week/:week/special-care` - 获取指定周的特需托管

## 开发步骤

### 第一阶段：基础环境搭建（1-2天）

#### 步骤1.1：项目初始化

1. 创建项目目录结构
2. 初始化package.json
3. 安装必要的npm包：
   ```bash
   npm init -y
   npm install express sqlite3 cors body-parser
   npm install --save-dev nodemon
   ```

#### 步骤1.2：数据库设置

1. 创建SQLite数据库文件
2. 编写数据库初始化脚本
3. 创建所有必要的表结构
4. 插入测试数据

#### 步骤1.3：基础服务器搭建

1. 创建Express服务器
2. 配置静态文件服务
3. 设置CORS和JSON解析中间件
4. 创建基础路由结构

### 第二阶段：核心功能开发（3-4天）

#### 步骤2.1：课程表显示功能

1. 创建HTML课程表结构（9×5网格）
2. 编写CSS样式，实现响应式布局
3. 实现JavaScript课程表渲染逻辑
4. 开发后端API获取课程数据
5. 实现前后端数据交互

#### 步骤2.2：教师管理功能

1. 创建教师选择下拉框
2. 实现教师切换功能
3. 开发教师CRUD API
4. 添加教师信息管理界面

#### 步骤2.3：时间管理功能

1. 实现学期配置功能
2. 开发周次计算逻辑
3. 创建周次导航组件
4. 实现日期与周次的双向转换

### 第三阶段：拖拽功能实现（2-3天）

#### 步骤3.1：基础拖拽功能

1. 实现HTML5 Drag and Drop API
2. 添加拖拽视觉反馈效果
3. 创建拖拽数据传输机制
4. 实现拖拽验证逻辑

#### 步骤3.2：课程移动功能

1. 开发课程位置更新API
2. 实现拖拽后的数据保存
3. 添加拖拽冲突检测
4. 创建操作撤销机制

#### 步骤3.3：拖拽优化

1. 优化拖拽性能
2. 添加拖拽动画效果
3. 实现拖拽边界限制
4. 添加拖拽状态指示

### 第四阶段：日历系统开发（2-3天）

#### 步骤4.1：基础日历功能

1. 创建月历显示组件
2. 实现日期选择功能
3. 开发日历导航功能
4. 添加日历样式设计

#### 步骤4.2：特需托管集成

1. 实现日历日期标记功能
2. 开发特需托管设置对话框
3. 创建特需托管CRUD功能
4. 实现日历与课程表联动

#### 步骤4.3：日历高级功能

1. 添加批量日期选择
2. 实现特需托管模板功能
3. 开发日历快速操作
4. 添加日历事件提醒

### 第五阶段：数据持久化与优化（1-2天）

#### 步骤5.1：数据保存机制

1. 实现自动保存功能
2. 开发手动保存确认
3. 创建数据备份机制
4. 添加数据恢复功能

#### 步骤5.2：操作历史功能

1. 实现操作记录保存
2. 开发撤销/重做功能
3. 创建操作历史查看
4. 添加批量操作支持

#### 步骤5.3：性能优化

1. 优化数据库查询
2. 实现前端缓存机制
3. 添加懒加载功能
4. 优化页面渲染性能

### 第六阶段：界面完善与测试（1-2天）

#### 步骤6.1：界面优化

1. 完善响应式设计
2. 添加加载状态指示
3. 优化用户交互体验
4. 添加错误处理提示

#### 步骤6.2：功能测试

1. 进行单元功能测试
2. 执行集成测试
3. 进行用户体验测试
4. 修复发现的问题

#### 步骤6.3：部署准备

1. 编写部署文档
2. 创建启动脚本
3. 配置生产环境
4. 进行最终测试

## 关键技术实现

### 1. 拖拽功能实现

```javascript
// 拖拽事件处理
function handleDragStart(event) {
    const courseElement = event.target;
    const courseData = {
        id: courseElement.dataset.courseId,
        weekday: courseElement.dataset.weekday,
        timeSlot: courseElement.dataset.timeSlot,
        courseName: courseElement.textContent.trim()
    };
  
    event.dataTransfer.setData('application/json', JSON.stringify(courseData));
    event.dataTransfer.effectAllowed = 'move';
  
    // 添加拖拽样式
    courseElement.classList.add('dragging');
}

function handleDrop(event) {
    event.preventDefault();
    const dropZone = event.target.closest('.time-slot');
    const courseData = JSON.parse(event.dataTransfer.getData('application/json'));
  
    // 验证拖拽目标
    if (validateDropTarget(dropZone, courseData)) {
        // 更新课程位置
        updateCoursePosition(courseData, dropZone);
    }
}
```

### 2. 时区处理

```javascript
// 东八区时间处理
function getBeijingTime() {
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const beijingTime = new Date(utc + (8 * 3600000));
    return beijingTime;
}

function calculateWeekNumber(startDate, currentDate) {
    const diffTime = Math.abs(currentDate - startDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return Math.ceil(diffDays / 7);
}
```

### 3. 数据同步机制

```javascript
// 数据同步处理
class DataSync {
    constructor() {
        this.pendingChanges = [];
        this.syncInterval = null;
    }
  
    addChange(changeData) {
        this.pendingChanges.push(changeData);
        this.debouncedSync();
    }
  
    debouncedSync() {
        clearTimeout(this.syncInterval);
        this.syncInterval = setTimeout(() => {
            this.syncToServer();
        }, 500);
    }
  
    async syncToServer() {
        if (this.pendingChanges.length === 0) return;
      
        try {
            const response = await fetch('/api/courses/batch-update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(this.pendingChanges)
            });
          
            if (response.ok) {
                this.pendingChanges = [];
            }
        } catch (error) {
            console.error('同步失败:', error);
        }
    }
}
```

## 部署方案

### 开发环境

```bash
# 启动开发服务器
npm run dev

# 数据库初始化
npm run init-db

# 运行测试
npm test
```

### 生产环境

```bash
# 安装依赖
npm install --production

# 启动生产服务器
npm start

# 使用PM2管理进程
pm2 start ecosystem.config.js
```

### 部署配置

```javascript
// ecosystem.config.js
module.exports = {
    apps: [{
        name: 'schedule-app',
        script: 'server.js',
        instances: 1,
        autorestart: true,
        watch: false,
        max_memory_restart: '1G',
        env: {
            NODE_ENV: 'production',
            PORT: 3000
        }
    }]
};
```

## 安全性考虑

### 1. 数据验证

- 前后端双重数据验证
- SQL注入防护
- XSS攻击防护

### 2. 访问控制

- 教师身份验证
- 操作权限控制
- 会话管理

### 3. 数据备份

- 定期数据库备份
- 操作日志记录
- 错误恢复机制

## 扩展性设计

### 1. 模块化架构

- 组件化设计
- 插件系统支持
- API版本管理

### 2. 功能扩展点

- 自定义时间段
- 多校区支持
- 移动端适配

### 3. 性能扩展

- 数据库分片
- 缓存系统
- CDN支持

## 项目交付

### 交付物清单

1. 完整的源代码
2. 数据库设计文档
3. API接口文档
4. 用户操作手册
5. 部署指南
6. 维护文档

### 技术支持

- 30天免费技术支持
- 问题修复服务
- 功能优化建议

---

**项目预估时间**: 10-12个工作日
**技术难度**: 中等
**维护复杂度**: 低
